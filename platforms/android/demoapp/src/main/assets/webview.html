<!--
  ~
  ~ Copyright (c) 2019, Salesforce.com, inc.
  ~ All rights reserved.
  ~ SPDX-License-Identifier: BSD-3-Clause
  ~ For full license text, see the LICENSE file in the repo root or https://opensource.org/licenses/BSD-3-Clause
  ~
  -->

<html>
<head>
</head>
<body>
    <input id='scanSingleBarcode' type='button' onClick='startScanning(false)' value='Scan Single Barcode'/>
<!--    TODO: Add this back in when activity does not close modal.  Otherwise this will close and start another activity each time-->
<!--    <input id='scanContinuousBarcode' type='button' onClick='startScanning(true)' value='Scan Continuous Barcodes'/>-->
    <div id="result"></div>
</body>
<script>

let barcodeScanner = __nimbus.plugins.barcodeScanner;
let deviceInfoPlugin = __nimbus.plugins.DeviceInfoPlugin;
let resultText = document.querySelector("#result");
let continuousScan = false;
let barcodesScanned = [];

function setResult(value){
    document.querySelector("#result").textContent = value;
}

let barcodeScannerCallback =
    (barcode, error) => {
        console.log(barcode);
        if (barcode !== null) {
            barcodesScanned.push("type: " + barcode.type + " value: " + decodeURIComponent(barcode.value));
            setResult(barcodesScanned);
            if (continuousScan){
                barcodeScanner.resumeCapture(barcodeScannerCallback);
            } else {
                barcodeScanner.endCapture()
            }
        } if (error !== null) {
            setResult("error: " + error);
        }
    };

if (typeof deviceInfoPlugin !== undefined && deviceInfoPlugin !== null){
    deviceInfoPlugin.getDeviceInfo().then( (deviceInfo) => {
        console.log(deviceInfo);
        setResult("Click Scan Barcode to begin. Current version: " + deviceInfo.appVersion);
    });
}

function startScanning(continuous) {
    barcodesScanned = [];
    continuousScan = continuous;
    if(typeof barcodeScanner !== undefined && barcodeScanner !== null){
        barcodeScanner.beginCapture(
            {"barcodeTypes": ["code128", "code39", "code93", "ean13", "ean8", "upce", "upca", "qr"]},
            barcodeScannerCallback
        );
    }
}
    </script>
</html>
